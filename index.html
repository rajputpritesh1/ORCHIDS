<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCHIDS Branch Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Free Map Engine) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .branch-card { transition: all 0.2s ease-in-out; }
        .branch-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #f97316;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #map { background-color: #e5e7eb; z-index: 1; } 
        
        /* Custom Marker Styles */
        .custom-marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #f97316;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .custom-marker-pin::after {
            content: '';
            width: 10px;
            height: 10px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        .user-marker-pin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #3b82f6, 0 4px 6px rgba(0,0,0,0.3);
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- LEFT SIDEBAR: Search & Results -->
    <div class="w-full md:w-1/3 lg:w-[400px] h-1/2 md:h-full flex flex-col bg-white shadow-xl z-20 relative">
        <!-- Header -->
        <div class="p-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white shrink-0">
            <h1 class="text-2xl font-bold">Find a School</h1>
            <p class="text-orange-100 text-sm mt-1">Locate the nearest ORCHIDS campus</p>
            <p class="text-orange-100 text-sm mt-1">Built with ❤ by Pritesh Rajput</p>
        </div>

        <!-- Search Inputs -->
        <div class="p-4 border-b border-gray-200 space-y-3 shrink-0 bg-gray-50">
            <div class="relative">
                <input type="text" id="manualLocation" placeholder="Enter Area, City or Pincode" 
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none shadow-sm text-sm">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <div class="flex gap-2">
                <button id="searchBtn" class="flex-1 bg-gray-900 hover:bg-gray-800 text-white py-2.5 rounded-lg font-medium text-sm transition-colors shadow-sm">
                    Search
                </button>
                <button id="locateMeBtn" class="flex-1 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 py-2.5 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-colors shadow-sm">
                    <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Use My Location
                </button>
            </div>
            
            <div id="statusMessage" class="text-xs text-center min-h-[20px] text-gray-500 font-medium"></div>
            
            <!-- Error Messages -->
            <div id="geocodeError" class="hidden p-3 bg-red-50 border border-red-200 text-red-600 rounded-md text-xs">
                Could not find that location. Please try a valid city or zipcode.
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 relative bg-slate-50">
            <!-- 1. Initial State -->
            <div id="initialState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 text-center p-6 z-0">
                <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p>Enter your location to see<br>Orchids schools near you.</p>
            </div>

            <!-- 2. No Results State -->
            <div id="noResults" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500 z-0">
                <p>No branches found nearby.</p>
            </div>

            <!-- 3. Results List -->
            <div id="resultsContainer" class="absolute inset-0 overflow-y-auto custom-scroll p-4 space-y-3 z-10"></div>
        </div>
    </div>

    <!-- RIGHT SIDE: Map -->
    <div class="w-full md:flex-1 h-1/2 md:h-full bg-gray-200 relative">
        <div id="map" class="w-full h-full"></div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <div class="loader w-10 h-10 border-4 border-t-orange-500 mb-3"></div>
            <p class="text-gray-700 font-semibold text-sm animate-pulse">Calculating Route...</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TOMTOM_API_KEY = 'mDqeJr5ga4WsG1WEYehTyFXqro5aTfi5';

        // --- Data: Complete Branch List ---
        const rawBranches = [
            // Bengaluru
            { name: 'Orchids The International School, Bannerghatta', area: 'Bannerghatta', city: 'Bengaluru', state: 'Karnataka', pincode: '560083', lat: 12.8710, lon: 77.5997 },
            { name: 'Orchids The International School, BTM Layout', area: 'BTM Layout', city: 'Bengaluru', state: 'Karnataka', pincode: '560076', lat: 12.9166, lon: 77.6101 },
            { name: 'Orchids The International School, CV Raman Nagar', area: 'CV Raman Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560093', lat: 12.9918, lon: 77.6586 },
            { name: 'Orchids The International School, Haralur', area: 'Haralur', city: 'Bengaluru', state: 'Karnataka', pincode: '560102', lat: 12.9060, lon: 77.6601 },
            { name: 'Orchids The International School, Hennur Road', area: 'Hennur Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560077', lat: 13.0360, lon: 77.6433 },
            { name: 'Orchids The International School, Horamavu', area: 'Horamavu', city: 'Bengaluru', state: 'Karnataka', pincode: '560043', lat: 13.0233, lon: 77.6633 },
            { name: 'Orchids The International School, Jakkur', area: 'Jakkur', city: 'Bengaluru', state: 'Karnataka', pincode: '560064', lat: 13.0780, lon: 77.6065 },
            { name: 'Orchids The International School, Jalahalli', area: 'Jalahalli', city: 'Bengaluru', state: 'Karnataka', pincode: '560013', lat: 13.0410, lon: 77.5450 },
            { name: 'Orchids The International School, JP Nagar', area: 'JP Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560078', lat: 12.9068, lon: 77.5843 },
            { name: 'Orchids The International School, Kadugodi', area: 'Kadugodi', city: 'Bengaluru', state: 'Karnataka', pincode: '560067', lat: 12.9934, lon: 77.7634 },
            { name: 'Orchids The International School, Kanakapura Road', area: 'Kanakapura Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560062', lat: 12.8931, lon: 77.5494 },
            { name: 'Orchids The International School, Kengeri', area: 'Kengeri', city: 'Bengaluru', state: 'Karnataka', pincode: '560060', lat: 12.9185, lon: 77.4827 },
            { name: 'Orchids The International School, Magadi Road', area: 'Magadi Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560079', lat: 12.9774, lon: 77.5235 },
            { name: 'Orchids The International School, Mahalakshmi Layout', area: 'Mahalakshmi Layout', city: 'Bengaluru', state: 'Karnataka', pincode: '560086', lat: 13.0098, lon: 77.5492 },
            { name: 'Orchids The International School, Majestic', area: 'Majestic', city: 'Bengaluru', state: 'Karnataka', pincode: '560009', lat: 12.9767, lon: 77.5713 },
            { name: 'Orchids The International School, Makali', area: 'Makali', city: 'Bengaluru', state: 'Karnataka', pincode: '562123', lat: 13.1119, lon: 77.4518 },
            { name: 'Orchids The International School, Mysore Road', area: 'Mysore Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560039', lat: 12.9461, lon: 77.5133 },
            { name: 'Orchids The International School, Nagarbhavi', area: 'Nagarbhavi', city: 'Bengaluru', state: 'Karnataka', pincode: '560072', lat: 12.9719, lon: 77.5126 },
            { name: 'Orchids The International School, Panathur', area: 'Panathur', city: 'Bengaluru', state: 'Karnataka', pincode: '560103', lat: 12.9523, lon: 77.7083 },
            { name: 'Orchids The International School, Rajaji Nagar', area: 'Rajaji Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560010', lat: 12.9904, lon: 77.5528 },
            { name: 'Orchids The International School, Sahakar Nagar', area: 'Sahakar Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560092', lat: 13.0598, lon: 77.5894 },
            { name: 'Orchids The International School, Sarjapur Road', area: 'Sarjapur Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560035', lat: 12.9129, lon: 77.6778 },
            { name: 'Orchids The International School, Vijaya Nagar', area: 'Vijaya Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560040', lat: 12.9698, lon: 77.5224 },
            { name: 'Orchids The International School, Whitefield', area: 'Whitefield', city: 'Bengaluru', state: 'Karnataka', pincode: '560066', lat: 12.9698, lon: 77.7499 },
            { name: 'Orchids The International School, Yelahanka', area: 'Yelahanka', city: 'Bengaluru', state: 'Karnataka', pincode: '560064', lat: 13.0999, lon: 77.5956 },
            { name: 'Orchids The International School, Yelahanka II', area: 'Yelahanka II', city: 'Bengaluru', state: 'Karnataka', pincode: '560064', lat: 13.1165, lon: 77.6073 },
            { name: 'Orchids The International School, Budigere Cross', area: 'Budigere Cross', city: 'Bengaluru', state: 'Karnataka', pincode: '560049', lat: 13.0240, lon: 77.7550 },

            // Mumbai
            { name: 'Orchids The International School, Borivali West', area: 'Borivali West', city: 'Mumbai', state: 'Maharashtra', pincode: '400092', lat: 19.2323, lon: 72.8485 },
            { name: 'Orchids The International School, Dombivli', area: 'Dombivli', city: 'Mumbai', state: 'Maharashtra', pincode: '421201', lat: 19.2184, lon: 73.0869 },
            { name: 'Orchids The International School, Koparkhairane', area: 'Koparkhairane', city: 'Mumbai', state: 'Maharashtra', pincode: '400709', lat: 19.1051, lon: 72.9942 },
            { name: 'Orchids The International School, Koparkhairane Sector 14', area: 'Koparkhairane Sector 14', city: 'Mumbai', state: 'Maharashtra', pincode: '400709', lat: 19.1022, lon: 73.0031 },
            { name: 'Orchids The International School, Kurla', area: 'Kurla', city: 'Mumbai', state: 'Maharashtra', pincode: '400070', lat: 19.0645, lon: 72.8806 },
            { name: 'Orchids The International School, Malad East', area: 'Malad East', city: 'Mumbai', state: 'Maharashtra', pincode: '400097', lat: 19.1895, lon: 72.8596 },
            { name: 'Orchids The International School, Malad West', area: 'Malad West', city: 'Mumbai', state: 'Maharashtra', pincode: '400064', lat: 19.1856, lon: 72.8335 },
            { name: 'Orchids The International School, Masjid Bunder', area: 'Masjid Bunder', city: 'Mumbai', state: 'Maharashtra', pincode: '400009', lat: 18.9548, lon: 72.8363 },
            { name: 'Orchids The International School, Mulund East', area: 'Mulund East', city: 'Mumbai', state: 'Maharashtra', pincode: '400081', lat: 19.1764, lon: 72.9525 },
            { name: 'Orchids The International School, Seawoods', area: 'Seawoods', city: 'Mumbai', state: 'Maharashtra', pincode: '400706', lat: 19.0343, lon: 73.0191 },
            { name: 'Orchids The International School, Sion', area: 'Sion', city: 'Mumbai', state: 'Maharashtra', pincode: '400022', lat: 19.0416, lon: 72.8631 },
            { name: 'Orchids The International School, Thane', area: 'Thane', city: 'Mumbai', state: 'Maharashtra', pincode: '400607', lat: 19.2183, lon: 72.9781 },
            { name: 'Orchids The International School, Vikhroli', area: 'Vikhroli', city: 'Mumbai', state: 'Maharashtra', pincode: '400079', lat: 19.0911, lon: 72.9231 },
            { name: 'Orchids The International School, Yari Road', area: 'Yari Road', city: 'Mumbai', state: 'Maharashtra', pincode: '400061', lat: 19.1258, lon: 72.8139 },

            // Pune
            { name: 'Orchids The International School, Ambegaon', area: 'Ambegaon', city: 'Pune', state: 'Maharashtra', pincode: '411046', lat: 18.4485, lon: 73.8344 },
            { name: 'Orchids The International School, Chinchwad', area: 'Chinchwad', city: 'Pune', state: 'Maharashtra', pincode: '411033', lat: 18.6272, lon: 73.7879 },
            { name: 'Orchids The International School, Hinjewadi', area: 'Hinjewadi', city: 'Pune', state: 'Maharashtra', pincode: '411057', lat: 18.5912, lon: 73.7389 },
            { name: 'Orchids The International School, Manjri', area: 'Manjri', city: 'Pune', state: 'Maharashtra', pincode: '412307', lat: 18.5085, lon: 73.9782 },
            { name: 'Orchids The International School, Nigdi', area: 'Nigdi', city: 'Pune', state: 'Maharashtra', pincode: '411044', lat: 18.6493, lon: 73.7629 },
            { name: 'Orchids The International School, Sus Road', area: 'Sus Road', city: 'Pune', state: 'Maharashtra', pincode: '411021', lat: 18.5445, lon: 73.7745 },
            { name: 'Orchids The International School, Swargate', area: 'Swargate', city: 'Pune', state: 'Maharashtra', pincode: '411037', lat: 18.5015, lon: 73.8635 },
            { name: 'Orchids The International School, Tathawade', area: 'Tathawade', city: 'Pune', state: 'Maharashtra', pincode: '411033', lat: 18.6087, lon: 73.7431 },
            { name: 'Orchids The International School, Undri', area: 'Undri', city: 'Pune', state: 'Maharashtra', pincode: '411060', lat: 18.4529, lon: 73.9016 },
            { name: 'Orchids The International School, Wadgaon Sheri', area: 'Wadgaon Sheri', city: 'Pune', state: 'Maharashtra', pincode: '411014', lat: 18.5601, lon: 73.9160 },

            // Hyderabad
            { name: 'Orchids The International School, Bachupally', area: 'Bachupally', city: 'Hyderabad', state: 'Telangana', pincode: '500090', lat: 17.5247, lon: 78.3850 },
            { name: 'Orchids The International School, Bandlaguda', area: 'Bandlaguda', city: 'Hyderabad', state: 'Telangana', pincode: '500086', lat: 17.3486, lon: 78.4116 },
            { name: 'Orchids The International School, Bolarum', area: 'Bolarum', city: 'Hyderabad', state: 'Telangana', pincode: '500010', lat: 17.5186, lon: 78.5304 },
            { name: 'Orchids The International School, Jubilee Hills', area: 'Jubilee Hills', city: 'Hyderabad', state: 'Telangana', pincode: '500033', lat: 17.4332, lon: 78.4069 },
            { name: 'Orchids The International School, Kapra', area: 'Kapra', city: 'Hyderabad', state: 'Telangana', pincode: '500062', lat: 17.4815, lon: 78.5731 },
            { name: 'Orchids The International School, Langar Houz', area: 'Langar Houz', city: 'Hyderabad', state: 'Telangana', pincode: '500008', lat: 17.3770, lon: 78.4239 },
            { name: 'Orchids The International School, Uppal', area: 'Uppal', city: 'Hyderabad', state: 'Telangana', pincode: '500039', lat: 17.4042, lon: 78.5630 },

            // Chennai
            { name: 'Orchids The International School, Korattur', area: 'Korattur', city: 'Chennai', state: 'Tamil Nadu', pincode: '600080', lat: 13.1119, lon: 80.1947 },
            { name: 'Orchids The International School, Manapakkam', area: 'Manapakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '600125', lat: 13.0200, lon: 80.1718 },
            { name: 'Orchids The International School, Pallavaram', area: 'Pallavaram', city: 'Chennai', state: 'Tamil Nadu', pincode: '600043', lat: 12.9731, lon: 80.1492 },
            { name: 'Orchids The International School, Pallikaranai', area: 'Pallikaranai', city: 'Chennai', state: 'Tamil Nadu', pincode: '600100', lat: 12.9377, lon: 80.2016 },
            { name: 'Orchids The International School, Perumbakkam', area: 'Perumbakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '600100', lat: 12.9213, lon: 80.2100 },
            { name: 'Orchids The International School, Pulianthope', area: 'Pulianthope', city: 'Chennai', state: 'Tamil Nadu', pincode: '600012', lat: 13.1064, lon: 80.2642 },
            { name: 'Orchids The International School, Thoraipakkam', area: 'Thoraipakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '600097', lat: 12.9511, lon: 80.2411 },
            { name: 'Orchids The International School, Velachery', area: 'Velachery', city: 'Chennai', state: 'Tamil Nadu', pincode: '600042', lat: 12.9785, lon: 80.2185 },
            { name: 'Orchids The International School, Vandalur', area: 'Vandalur', city: 'Chennai', state: 'Tamil Nadu', pincode: '600048', lat: 12.8916, lon: 80.0818 },

            // Kolkata
            { name: 'Orchids The International School, Joka', area: 'Joka', city: 'Kolkata', state: 'West Bengal', pincode: '700104', lat: 22.4633, lon: 88.3048 },
            { name: 'Orchids The International School, Madhyamgram', area: 'Madhyamgram', city: 'Kolkata', state: 'West Bengal', pincode: '700129', lat: 22.7001, lon: 88.4511 },
            { name: 'Orchids The International School, Newtown', area: 'Newtown', city: 'Kolkata', state: 'West Bengal', pincode: '700156', lat: 22.5726, lon: 88.4339 },

            // Gurgaon
            { name: 'Orchids The International School, Dwarka Expressway', area: 'Dwarka Expressway', city: 'Gurgaon', state: 'Haryana', pincode: '122017', lat: 28.5282, lon: 77.0180 },
            { name: 'Orchids The International School, Golf Course Road', area: 'Golf Course Road', city: 'Gurgaon', state: 'Haryana', pincode: '122002', lat: 28.4566, lon: 77.0917 },
            { name: 'Orchids The International School, Sector 56', area: 'Sector 56', city: 'Gurgaon', state: 'Haryana', pincode: '122011', lat: 28.4217, lon: 77.0911 },
            { name: 'Orchids The International School, South City 1', area: 'South City 1', city: 'Gurgaon', state: 'Haryana', pincode: '122001', lat: 28.4485, lon: 77.0628 },

            // Indore
            { name: 'Orchids The International School, Aurobindo Square', area: 'Aurobindo Square', city: 'Indore', state: 'Madhya Pradesh', pincode: '452010', lat: 22.7533, lon: 75.8937 },
            { name: 'Orchids The International School, Rajendra Nagar', area: 'Rajendra Nagar', city: 'Indore', state: 'Madhya Pradesh', pincode: '452012', lat: 22.6844, lon: 75.8306 },

            // Sonipat
            { name: 'Orchids The International School, New Braham Colony', area: 'New Braham Colony', city: 'Sonipat', state: 'Haryana', pincode: '131001', lat: 28.9956, lon: 77.0184 },
            { name: 'Orchids The International School, Bahalgarh', area: 'Bahalgarh', city: 'Sonipat', state: 'Haryana', pincode: '131021', lat: 29.0700, lon: 77.0378 },

            // Delhi
            { name: 'Orchids The International School, Dwarka Sector-19', area: 'Dwarka Sector-19', city: 'Delhi', state: 'Delhi', pincode: '110075', lat: 28.5835, lon: 77.0505 },

            // Chh Sambhaji Nagar (Aurangabad)
            { name: 'Orchids The International School, TCH Adgaon', area: 'TCH Adgaon', city: 'Chh Sambhabji Nagar', state: 'Maharashtra', pincode: '422003', lat: 20.0266, lon: 73.8229 }, 
            { name: 'Orchids The International School, N6 Cidco', area: 'N6 Cidco', city: 'Aurangabad', state: 'Maharashtra', pincode: '431003', lat: 19.8700, lon: 75.3500 },

            // Ahmednagar
            { name: 'Orchids The International School, Dhangarwadi', area: 'Dhangarwadi', city: 'Ahmednagar', state: 'Maharashtra', pincode: '414005', lat: 19.1413, lon: 74.7937 },

            // Rohtak
            { name: 'Orchids The International School, Gohana Road', area: 'Gohana Road', city: 'Rohtak', state: 'Haryana', pincode: '124001', lat: 28.8955, lon: 76.5894 },

            // Tumkur
            { name: 'Orchids The International School, SiraGate', area: 'SiraGate', city: 'Tumakuru', state: 'Karnataka', pincode: '572106', lat: 13.3618, lon: 77.0945 },

            // Nagpur
            { name: 'Orchids The International School, Koradi Road', area: 'Koradi Road', city: 'Nagpur', state: 'Maharashtra', pincode: '441111', lat: 21.2290, lon: 79.0911 },

            // Bhopal
            { name: 'Orchids The International School, Hoshangabad Road', area: 'Hoshangabad Road', city: 'Bhopal', state: 'Madhya Pradesh', pincode: '462026', lat: 23.1815, lon: 77.4419 },

            // Jabalpur
            { name: 'Orchids The International School, Bhedaghat Road', area: 'Bhedaghat Road', city: 'Jabalpur', state: 'Madhya Pradesh', pincode: '482003', lat: 23.1367, lon: 79.8248 },

            // Hubli-Dharwad
            { name: 'Orchids The International School, Charantimath Gardens', area: 'Charantimath Gardens', city: 'Dharwad', state: 'Karnataka', pincode: '580001', lat: 15.4589, lon: 75.0078 },
            { name: 'Orchids The International School, Airport Road', area: 'Airport Road', city: 'Hubballi', state: 'Karnataka', pincode: '580027', lat: 15.3647, lon: 75.0849 },
        ];

        // Deduplication Function
        function removeDuplicates(arr) {
            const unique = new Map();
            arr.forEach(item => {
                if(!unique.has(item.name)) {
                    unique.set(item.name, item);
                }
            });
            return Array.from(unique.values());
        }

        const branches = removeDuplicates(rawBranches);

        // --- GLOBAL STATE ---
        let map;
        let currentMarkers = [];
        let currentRouteLayer = null;
        let currentRouteOutline = null;
        let currentUserMarker = null; 
        let searchSessionId = 0; 

        // Initialize Map (Leaflet)
        function initMap() {
            try {
                // Initialize Leaflet map with OpenStreetMap tiles (FREE, No Key Required)
                map = L.map('map').setView([20.5937, 78.9629], 4);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                
            } catch(e) {
                console.error("Map initialization failed:", e);
            }
        }

        // Initialize map on load
        window.addEventListener('load', initMap);

        // --- MAP FUNCTIONS ---

        // Clean map state (Markers & Route) safely
        function clearMap() {
             // Clear Branch Markers
             currentMarkers.forEach(m => map.removeLayer(m));
             currentMarkers = [];

             // Clear User Marker
             if (currentUserMarker) {
                 map.removeLayer(currentUserMarker);
                 currentUserMarker = null;
             }

             if(!map) return;

             // Clear Route Layers
             if (currentRouteLayer) {
                 map.removeLayer(currentRouteLayer);
                 currentRouteLayer = null;
             }
             if (currentRouteOutline) {
                 map.removeLayer(currentRouteOutline);
                 currentRouteOutline = null;
             }
        }

        // Add a marker safely
        function addMarker(lat, lon, popupHTML) {
            if(!map) return null;
            try {
                // Custom Orange Icon using DivIcon to match original style
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div class="custom-marker-pin"></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -32]
                });

                const marker = L.marker([lat, lon], {icon: customIcon})
                    .addTo(map)
                    .bindPopup(popupHTML);
                return marker;
            } catch(e) { console.log('Add marker error', e); return null; }
        }

        // Fly to location safely
        function flyToLocation(lon, lat, zoomLevel) {
            if(map) {
                map.flyTo([lat, lon], zoomLevel);
            }
        }

        // 1. Basic Haversine (Crow flies) for initial filtering
        function getCrowDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // 3. Draw Route on Map (On Demand) - Uses TomTom API for Routing, Leaflet for Drawing
        async function drawRoute(userLat, userLon, destLat, destLon) {
            if(!map) { alert("Map not loaded properly."); return; }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            const currentSessionId = searchSessionId;

            // Remove previous route
            if (currentRouteLayer) map.removeLayer(currentRouteLayer);
            if (currentRouteOutline) map.removeLayer(currentRouteOutline);
            
            const url = `https://api.tomtom.com/routing/1/calculateRoute/${userLat},${userLon}:${destLat},${destLon}/json?instructionsType=text&language=en-US&computeBestOrder=false&routeRepresentation=polyline&key=${TOMTOM_API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                loadingOverlay.classList.add('hidden');

                if (currentSessionId !== searchSessionId) return; // Search changed

                if (data.routes && data.routes.length > 0) {
                    const points = data.routes[0].legs[0].points;
                    // Convert TomTom points {latitude, longitude} to Leaflet [lat, lon]
                    const latlngs = points.map(p => [p.latitude, p.longitude]);

                    // Draw Outline (White)
                    currentRouteOutline = L.polyline(latlngs, {
                        color: 'white',
                        weight: 8,
                        opacity: 0.9,
                        lineJoin: 'round'
                    }).addTo(map);

                    // Draw Route (Blue)
                    currentRouteLayer = L.polyline(latlngs, {
                        color: '#3b82f6',
                        weight: 5,
                        opacity: 1,
                        lineJoin: 'round'
                    }).addTo(map);
                    
                    // Fit bounds to route
                    map.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 50] });
                }
            } catch (e) {
                console.error("Error drawing route:", e);
                loadingOverlay.classList.add('hidden');
            }
        }

        async function findNearbyBranches(userLon, userLat) {
            // 1. Increment Session ID
            searchSessionId++;

            // 2. Clear old map data
            clearMap();

            // 3. IMMEDIATE FEEDBACK
            flyToLocation(userLon, userLat, 11);

            // 4. Calculate Crow Distance ONLY (FAST)
            const allWithDist = branches.map(b => {
                const dist = getCrowDistance(userLat, userLon, b.lat, b.lon);
                return { ...b, distance: dist, roadDistance: dist }; 
            });

            // 5. SORT ALL
            allWithDist.sort((a, b) => a.distance - b.distance);

            // 6. SMART FILTERING
            // First, try to get branches within 15km
            let nearbyBranches = allWithDist.filter(b => b.distance <= 15);
            let displayMessage = "";

            // FAILSAFE: If no branches within 15km, take top 3 anyway
            // This prevents "Nothing Showing" when searching for City Centers far from suburbs
            if (nearbyBranches.length === 0) {
                nearbyBranches = allWithDist.slice(0, 3);
                displayMessage = "No branches within 15km. Showing closest:";
            }

            // 7. RENDER
            renderResults(nearbyBranches, userLat, userLon, displayMessage);
        }

        function renderResults(results, userLat, userLon, message) {
            const container = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const initialState = document.getElementById('initialState');
            
            // Clear only the results container contents
            container.innerHTML = '';
            
            // Hide state icons
            initialState.classList.add('hidden');
            
            // Render Warning Message if any
            if(message) {
                const msgDiv = document.createElement('div');
                msgDiv.className = "text-xs font-semibold text-orange-600 bg-orange-50 p-2 rounded mb-2 border border-orange-100";
                msgDiv.textContent = message;
                container.appendChild(msgDiv);
            }

            // Add User Marker
            if(map) {
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: '<div class="user-marker-pin"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                currentUserMarker = L.marker([userLat, userLon], {icon: userIcon})
                    .addTo(map)
                    .bindPopup("Your Location");
            }

            if (results.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            // Collect bounds to zoom to fit all results
            const bounds = L.latLngBounds();
            bounds.extend([userLat, userLon]);

            results.forEach((branch, index) => {
                // Simplified Distance Display (Fast)
                const distDisplay = `<span class="text-gray-600 font-bold">${branch.distance.toFixed(1)} km</span> <span class="text-xs text-gray-400">(Direct)</span>`;

                const card = document.createElement('div');
                card.className = 'branch-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-2 cursor-pointer';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${branch.area}</h3>
                            <p class="text-xs text-gray-500">${branch.city}, ${branch.state}</p>
                        </div>
                        <div class="text-right">
                           ${distDisplay}
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">${branch.name}</div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="drawRoute(${userLat}, ${userLon}, ${branch.lat}, ${branch.lon})" class="flex-1 bg-orange-50 text-orange-600 text-xs font-semibold py-2 rounded border border-orange-100 hover:bg-orange-100 transition-colors">
                            Show Route
                        </button>
                         <a href="https://www.google.com/maps/dir/?api=1&destination=${branch.lat},${branch.lon}" target="_blank" class="flex-1 text-center bg-gray-50 text-gray-600 text-xs font-semibold py-2 rounded border border-gray-200 hover:bg-gray-100 transition-colors">
                            Google Maps
                        </a>
                    </div>
                `;
                
                card.addEventListener('click', (e) => {
                    if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') {
                         flyToLocation(branch.lon, branch.lat, 14);
                    }
                });

                container.appendChild(card);

                // Add map marker
                const marker = addMarker(branch.lat, branch.lon, `<b class="text-black">${branch.area}</b><br>${branch.distance.toFixed(1)} km`);
                if(marker) currentMarkers.push(marker);
                
                bounds.extend([branch.lat, branch.lon]);
            });

            if(map && currentMarkers.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // --- Event Listeners ---
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const query = document.getElementById('manualLocation').value;
            const errorBox = document.getElementById('geocodeError');
            const container = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const initialState = document.getElementById('initialState');

            errorBox.classList.add('hidden');
            
            if(!query) return;

            // INSTANT CLEAR: Hide previous results immediately
            container.innerHTML = ''; 
            noResults.classList.add('hidden');
            
            // Show loading state
            if(initialState) initialState.classList.remove('hidden'); 

            try {
                // Using TomTom Geocoding for better search results (TomTom still works fine, just map display was broken)
                const url = `https://api.tomtom.com/search/2/geocode/${encodeURIComponent(query)}.json?key=${TOMTOM_API_KEY}`;
                const resp = await fetch(url);
                const data = await resp.json();
                
                if(data.results && data.results.length > 0) {
                    const lat = data.results[0].position.lat;
                    const lon = data.results[0].position.lon;
                    if(initialState) initialState.classList.add('hidden'); 
                    findNearbyBranches(lon, lat);
                } else {
                    if(initialState) initialState.classList.add('hidden');
                    errorBox.classList.remove('hidden');
                }
            } catch(e) {
                console.error(e);
                if(initialState) initialState.classList.add('hidden');
                errorBox.classList.remove('hidden');
            }
        });

        // Add Enter key support
        document.getElementById('manualLocation').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        document.getElementById('locateMeBtn').addEventListener('click', () => {
            const initialState = document.getElementById('initialState');
            
            if (navigator.geolocation) {
                // Clear previous results instantly
                document.getElementById('resultsContainer').innerHTML = '';
                document.getElementById('noResults').classList.add('hidden');
                if(initialState) initialState.classList.remove('hidden');

                navigator.geolocation.getCurrentPosition(pos => {
                    if(initialState) initialState.classList.add('hidden');
                    findNearbyBranches(pos.coords.longitude, pos.coords.latitude);
                }, () => {
                    document.getElementById('statusMessage').textContent = "Unable to retrieve location.";
                });
            } else {
                document.getElementById('statusMessage').textContent = "Geolocation not supported.";
            }
        });

    </script>
</body>
</html>
