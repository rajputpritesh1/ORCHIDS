<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORCHIDS Branch Search - Secure Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .branch-card {
            transition: all 0.2s ease-in-out;
        }

        .branch-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #f97316;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        #map {
            background-color: #e5e7eb;
            z-index: 1;
        }

        /* Markers */
        .custom-marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #f97316;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
        }

        .custom-marker-pin::after {
            content: '';
            width: 10px;
            height: 10px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        .user-marker-pin {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #3b82f6;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* --- LOGIN SPECIFIC STYLES --- */
        .blur-app {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .login-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }
    </style>
</head>

<body class="h-screen overflow-hidden relative">

    <div id="loginOverlay"
        class="fixed inset-0 z-[9999] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4">
        <div id="loginBox"
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden login-fade-in border border-orange-100">
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-8 text-center relative overflow-hidden">
                <div
                    class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10">
                </div>
                <div class="relative z-10">
                    <div
                        class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-white tracking-wide">Orchids Staff Portal</h2>
                    <p class="text-orange-100 text-sm mt-1">Please authenticate to continue</p>
                </div>
            </div>

            <div class="p-8 bg-white">
                <div id="authMessage"
                    class="hidden mb-4 p-3 rounded-lg text-xs font-bold text-center uppercase tracking-wider"></div>

                <form id="loginForm" class="space-y-5">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">ERP ID
                            (Username)</label>
                        <input type="number" id="username"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 outline-none transition-all"
                            placeholder="Enter your ERP ID">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Password
                            (Pass Key)</label>
                        <input type="password" id="password"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-orange-500 focus:ring-4 focus:ring-orange-500/10 outline-none transition-all"
                            placeholder="Enter Password">
                    </div>
                    <button type="submit"
                        class="w-full bg-gray-900 hover:bg-gray-800 text-white font-bold py-3.5 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                        Secure Login
                    </button>
                </form>

                <p class="text-center text-xs text-gray-400 mt-6 flex items-center justify-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                        </path>
                    </svg>
                    Session valid for 9 hours
                </p>
            </div>
        </div>
    </div>

    <div id="mainApp" class="h-screen flex flex-col md:flex-row overflow-hidden blur-app transition-all duration-500">
        <div class="w-full md:w-1/3 lg:w-[400px] h-1/2 md:h-full flex flex-col bg-white shadow-xl z-20 relative">
            <div class="p-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white shrink-0 relative">

                <div id="agentProfile"
                    class="hidden mb-4 bg-white/10 p-3 rounded-lg backdrop-blur-sm border border-white/20 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white text-orange-600 flex items-center justify-center font-bold text-lg shadow-sm"
                                id="agentAvatar">
                                </div>
                            <div>
                                <p class="text-sm font-bold text-white" id="agentName">Loading...</p>
                                <div class="flex items-center gap-2">
                                    <p class="text-xs text-orange-100" id="agentErp">ERP: ---</p>
                                    <span
                                        class="px-1.5 py-0.5 bg-green-500/20 text-green-100 text-[10px] font-bold rounded border border-green-400/30 flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                                        ACTIVE
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button onclick="performLogout()"
                            class="text-xs bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded transition-colors border border-white/30">
                            Logout
                        </button>
                    </div>
                </div>

                <h1 class="text-2xl font-bold">Find a School</h1>
                <p class="text-orange-100 text-sm mt-1">Locate the nearest ORCHIDS campus</p>
            </div>
           
            <div class="p-4 border-b border-gray-200 space-y-3 shrink-0 bg-gray-50">
                <div class="relative">
                    <input type="text" id="manualLocation" placeholder="Enter Area, City or Pincode"
                        class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none shadow-sm text-sm">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <div class="flex gap-2">
                    <button id="searchBtn"
                        class="flex-1 bg-gray-900 hover:bg-gray-800 text-white py-2.5 rounded-lg font-medium text-sm transition-colors shadow-sm">
                        Search
                    </button>
                    <button id="locateMeBtn"
                        class="flex-1 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 py-2.5 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-colors shadow-sm">
                        <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Use My Location
                    </button>
                </div>

                <div id="statusMessage" class="text-xs text-center min-h-[20px] text-gray-500 font-medium"></div>

                <div id="geocodeError"
                    class="hidden p-3 bg-red-50 border border-red-200 text-red-600 rounded-md text-xs">
                    Could not find that location. Please try a valid city or zipcode.
                </div>
            </div>

            <div class="flex-1 relative bg-slate-50">
                <div id="initialState"
                    class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 text-center p-6 z-0">
                    <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <p>Enter your location to see<br>Orchids schools near you.</p>
                </div>
                <div id="noResults"
                    class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500 z-0">
                    <p>No branches found nearby.</p>
                </div>
                <div id="resultsContainer" class="absolute inset-0 overflow-y-auto custom-scroll p-4 space-y-3 z-10">
                </div>
            </div>
        </div>

        <div class="w-full md:flex-1 h-1/2 md:h-full bg-gray-200 relative">
            <div id="map" class="w-full h-full"></div>
            <div id="loadingOverlay"
                class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
                <div class="loader w-10 h-10 border-4 border-t-orange-500 mb-3"></div>
                <p class="text-gray-700 font-semibold text-sm animate-pulse">Calculating Route...</p>
            </div>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION CONFIG ---
        // Using localStorage keys for better persistence on local file systems
        const STORAGE_KEY_TOKEN = "orchids_auth_token";
        const STORAGE_KEY_NAME = "orchids_user_name";
        const STORAGE_KEY_ERP = "orchids_user_erp";
        const STORAGE_KEY_SESSION = "orchids_session_id";
        const STORAGE_KEY_EXPIRY = "orchids_auth_expiry";

        const COOKIE_DURATION_HOURS = 9;
        const CHECK_INTERVAL_MS = 2000; // Check faster for better security
        const JSON_FILE_PATH = 'users.json';

        // -----------------------------------------------------
        // FALLBACK DATA (Using the UPDATED List Provided)
        // -----------------------------------------------------
        const FALLBACK_USERS = {
            "authorized_users": [
                { "Name": "Shaik Khaja", "ERP": 20252000178, "PASS": "20252000178" },
                { "Name": "Meghana N", "ERP": 20252000216, "PASS": "20252000216" },
                { "Name": "Hemanth L", "ERP": 20252000264, "PASS": "20252000264" },
                { "Name": "Reck chatterjee", "ERP": 20252000334, "PASS": "20252000334" },
                { "Name": "Ullas J", "ERP": 20252000431, "PASS": "20252000431" },
                { "Name": "Dinesh Pal", "ERP": 20252000542, "PASS": "20252000542" },
                // { "Name": "Akshitha C S", "ERP": 20252000544, "PASS": "20252000544" },
                { "Name": "Dhanush S", "ERP": 20252000472, "PASS": "20252000472" },
                { "Name": "Vijay Surya A", "ERP": 20252000540, "PASS": "20252000540" },
                { "Name": "Chandan N", "ERP": 20252000557, "PASS": "20252000557" },
                { "Name": "Darshan Rathod", "ERP": 20252000677, "PASS": "20252000677" },
                { "Name": "Charan D S", "ERP": 20250002226, "PASS": "20250002226" },
                { "Name": "AKASH R", "ERP": 20256010065, "PASS": "20256010065" },
                { "Name": "PRITESH KUMAR", "ERP": 20252000592025200059, "PASS": "2025200059""2025200059" },
                { "Name": "Nayana R", "ERP": 20252000181, "PASS": "20252000181" },
                { "Name": "Ankit Kumar", "ERP": 20252000179, "PASS": "20252000179" },
                { "Name": "Krishna gopal paul", "ERP": 20252000800, "PASS": "20252000800" },
                { "Name": "Raghavendra MS", "ERP": 20252001086, "PASS": "20252001086" },
                { "Name": "Swathi Pawar", "ERP": 20252001081, "PASS": "20252001081" },
                { "Name": "S KAVAN", "ERP": 20240000006, "PASS": "20240000006" },
                { "Name": "R ARUNA", "ERP": 20240001113, "PASS": "20240001113" },
                { "Name": "LUKE", "ERP": 20252000505, "PASS": "20252000505" },
                { "Name": "MEGHNA G", "ERP": 20252000490, "PASS": "20252000490" }
            ]
        };

        // 1. Storage Management (Replaces plain cookies for robustness)
        function setAuth(name, erp) {
            const now = new Date();
            const expiry = now.getTime() + (COOKIE_DURATION_HOURS * 60 * 60 * 1000);
            const sessionId = Math.random().toString(36).substring(2) + Date.now().toString(36);

            // Set LocalStorage (Primary for File:// and refresh persistence)
            localStorage.setItem(STORAGE_KEY_TOKEN, "active");
            localStorage.setItem(STORAGE_KEY_NAME, name);
            localStorage.setItem(STORAGE_KEY_ERP, erp);
            localStorage.setItem(STORAGE_KEY_EXPIRY, expiry);
            localStorage.setItem(STORAGE_KEY_SESSION, sessionId);
        }

        function clearAuth() {
            localStorage.removeItem(STORAGE_KEY_TOKEN);
            localStorage.removeItem(STORAGE_KEY_NAME);
            localStorage.removeItem(STORAGE_KEY_ERP);
            localStorage.removeItem(STORAGE_KEY_EXPIRY);
            localStorage.removeItem(STORAGE_KEY_SESSION);
        }

        function isAuthValid() {
            const token = localStorage.getItem(STORAGE_KEY_TOKEN);
            const expiry = localStorage.getItem(STORAGE_KEY_EXPIRY);
            const now = new Date().getTime();

            if (!token || !expiry) return false;
            if (now > parseInt(expiry)) {
                clearAuth(); // Expired
                return false;
            }
            return true;
        }

        // 2. Auth Interface Logic
        const overlay = document.getElementById('loginOverlay');
        const mainApp = document.getElementById('mainApp');
        const loginBox = document.getElementById('loginBox');
        const msgDiv = document.getElementById('authMessage');

        function showLogin(message = null, isError = false) {
            if (!overlay.classList.contains('hidden')) {
                // Already showing, just update message if needed
                if (message) updateMsg(message, isError);
                return;
            }
            overlay.classList.remove('hidden');
            mainApp.classList.add('blur-app');
            if (message) updateMsg(message, isError);
        }

        function updateMsg(message, isError) {
            msgDiv.textContent = message;
            msgDiv.classList.remove('hidden');
            msgDiv.className = isError
                ? "mb-4 p-3 rounded-lg text-xs font-bold text-center uppercase tracking-wider bg-red-100 text-red-600 border border-red-200 block"
                : "mb-4 p-3 rounded-lg text-xs font-bold text-center uppercase tracking-wider bg-blue-100 text-blue-600 border border-blue-200 block";
            if (isError) {
                loginBox.classList.remove('shake');
                void loginBox.offsetWidth; // Trigger reflow
                loginBox.classList.add('shake');
            }
        }

        function hideLogin() {
            overlay.classList.add('hidden');
            mainApp.classList.remove('blur-app');
        }

        function performLogout() {
            clearAuth();
            showLogin("Logged out successfully", false);
            // Hide profile
            document.getElementById('agentProfile').classList.add('hidden');
        }

        function updateAgentUI(name, erp) {
            const profileDiv = document.getElementById('agentProfile');
            const nameEl = document.getElementById('agentName');
            const erpEl = document.getElementById('agentErp');
            const avatarEl = document.getElementById('agentAvatar');

            if (name && erp) {
                profileDiv.classList.remove('hidden');
                nameEl.textContent = name;
                erpEl.textContent = `ERP: ${erp}`;

                // Initials logic
                const names = name.split(' ');
                let initials = names[0].charAt(0);
                if (names.length > 1) initials += names[names.length - 1].charAt(0);
                avatarEl.textContent = initials.toUpperCase();
            }
        }

        // 3. User Data Fetcher
        async function fetchUsers() {
            try {
                const response = await fetch(JSON_FILE_PATH);
                if (!response.ok) throw new Error('File not found');
                const data = await response.json();
                return data.authorized_users || [];
            } catch (error) {
                console.warn("Could not fetch users.json. Using fallback data.", error);
                return FALLBACK_USERS.authorized_users;
            }
        }

        // 4. Form Submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;

            if (!u || !p) {
                updateMsg("Please enter ERP and Password", true);
                return;
            }

            // --- SECURITY CHECK SIMULATION ---
            // NOTE: To enforce strict "One Device Only" (e.g., blocking login if active on another laptop),
            // you need a backend server (Firebase/SQL).
            // This simulation below prevents double-login behavior locally and displays the requested error message.
            if (isAuthValid()) {
                const currentErp = localStorage.getItem(STORAGE_KEY_ERP);
                if (currentErp !== u) {
                    updateMsg("ALREADY SESSION CREATED. CONTACT ADMIN.", true);
                    return;
                }
            }

            btn.innerText = "Verifying Credentials...";
            btn.disabled = true;
            btn.classList.add('opacity-75');

            const users = await fetchUsers();

            // Match against JSON fields: ERP and PASS
            const validUser = users.find(user =>
                String(user.ERP) === u &&
                String(user.PASS) === p
            );

            if (validUser) {
                setAuth(validUser.Name, validUser.ERP);
                updateAgentUI(validUser.Name, validUser.ERP);
                hideLogin();

                document.getElementById('username').value = "";
                document.getElementById('password').value = "";
            } else {
                updateMsg("Invalid ERP or Password", true);
            }

            btn.innerText = originalText;
            btn.disabled = false;
            btn.classList.remove('opacity-75');
        });

        // 5. THE ENFORCER & SYNC
        function checkAuthStatus() {
            if (!isAuthValid()) {
                if (overlay.classList.contains('hidden')) {
                    showLogin("Session Expired. Please Login.", true);
                    document.getElementById('agentProfile').classList.add('hidden');
                }
            } else {
                // If logged in, ensure UI is up to date (handles refresh)
                const name = localStorage.getItem(STORAGE_KEY_NAME);
                const erp = localStorage.getItem(STORAGE_KEY_ERP);
                if (name && erp) {
                    if (document.getElementById('agentProfile').classList.contains('hidden')) {
                        updateAgentUI(name, erp);
                        hideLogin();
                    }
                }
            }
        }

        // ** MULTI-TAB SYNC LISTENER **
        // This ensures if you login in one tab, other tabs update.
        // Or if you logout in one tab, others logout.
        window.addEventListener('storage', (event) => {
            if (event.key === STORAGE_KEY_TOKEN || event.key === STORAGE_KEY_SESSION) {
                // If token changes (login or logout happened elsewhere)
                checkAuthStatus();
            }
        });

        // Run immediately
        checkAuthStatus();

        // Run interval
        setInterval(checkAuthStatus, CHECK_INTERVAL_MS);

        // --- EXISTING MAP LOGIC BELOW ---
        const TOMTOM_API_KEY = 'mDqeJr5ga4WsG1WEYehTyFXqro5aTfi5';

        const rawBranches = [
            { name: 'Orchids The International School, Bannerghatta', area: 'Bannerghatta', city: 'Bengaluru', state: 'Karnataka', pincode: '560083', lat: 12.8710, lon: 77.5997 },
            { name: 'Orchids The International School, BTM Layout', area: 'BTM Layout', city: 'Bengaluru', state: 'Karnataka', pincode: '560076', lat: 12.9166, lon: 77.6101 },
            { name: 'Orchids The International School, CV Raman Nagar', area: 'CV Raman Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560093', lat: 12.9918, lon: 77.6586 },
            { name: 'Orchids The International School, Haralur', area: 'Haralur', city: 'Bengaluru', state: 'Karnataka', pincode: '560102', lat: 12.9060, lon: 77.6601 },
            { name: 'Orchids The International School, Hennur Road', area: 'Hennur Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560077', lat: 13.0360, lon: 77.6433 },
            { name: 'Orchids The International School, Horamavu', area: 'Horamavu', city: 'Bengaluru', state: 'Karnataka', pincode: '560043', lat: 13.0233, lon: 77.6633 },
            { name: 'Orchids The International School, Jakkur', area: 'Jakkur', city: 'Bengaluru', state: 'Karnataka', pincode: '560064', lat: 13.0780, lon: 77.6065 },
            { name: 'Orchids The International School, Jalahalli', area: 'Jalahalli', city: 'Bengaluru', state: 'Karnataka', pincode: '560013', lat: 13.0410, lon: 77.5450 },
            { name: 'Orchids The International School, JP Nagar', area: 'JP Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560078', lat: 12.9068, lon: 77.5843 },
            { name: 'Orchids The International School, Kadugodi', area: 'Kadugodi', city: 'Bengaluru', state: 'Karnataka', pincode: '560067', lat: 12.9934, lon: 77.7634 },
            { name: 'Orchids The International School, Kanakapura Road', area: 'Kanakapura Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560062', lat: 12.8931, lon: 77.5494 },
            { name: 'Orchids The International School, Kengeri', area: 'Kengeri', city: 'Bengaluru', state: 'Karnataka', pincode: '560060', lat: 12.9185, lon: 77.4827 },
            { name: 'Orchids The International School, Magadi Road', area: 'Magadi Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560079', lat: 12.9774, lon: 77.5235 },
            { name: 'Orchids The International School, Mahalakshmi Layout', area: 'Mahalakshmi Layout', city: 'Bengaluru', state: 'Karnataka', pincode: '560086', lat: 13.0098, lon: 77.5492 },
            { name: 'Orchids The International School, Majestic', area: 'Majestic', city: 'Bengaluru', state: 'Karnataka', pincode: '560009', lat: 12.9767, lon: 77.5713 },
            { name: 'Orchids The International School, Makali', area: 'Makali', city: 'Bengaluru', state: 'Karnataka', pincode: '562123', lat: 13.1119, lon: 77.4518 },
            { name: 'Orchids The International School, Mysore Road', area: 'Mysore Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560039', lat: 12.9461, lon: 77.5133 },
            { name: 'Orchids The International School, Nagarbhavi', area: 'Nagarbhavi', city: 'Bengaluru', state: 'Karnataka', pincode: '560072', lat: 12.9719, lon: 77.5126 },
            { name: 'Orchids The International School, Panathur', area: 'Panathur', city: 'Bengaluru', state: 'Karnataka', pincode: '560103', lat: 12.9523, lon: 77.7083 },
            { name: 'Orchids The International School, Rajaji Nagar', area: 'Rajaji Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560010', lat: 12.9904, lon: 77.5528 },
            { name: 'Orchids The International School, Sahakar Nagar', area: 'Sahakar Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560092', lat: 13.0598, lon: 77.5894 },
            { name: 'Orchids The International School, Hesaraghatta Road', area: 'Mallasandra', city: 'Bengaluru', state: 'Karnataka', pincode: '560057', lat: 13.0485, lon: 77.5145 },
            { name: 'Orchids The International School, Sarjapur Road', area: 'Sarjapur Road', city: 'Bengaluru', state: 'Karnataka', pincode: '560035', lat: 12.9129, lon: 77.6778 },
            { name: 'Orchids The International School, Vijaya Nagar', area: 'Vijaya Nagar', city: 'Bengaluru', state: 'Karnataka', pincode: '560040', lat: 12.9698, lon: 77.5224 },
            { name: 'Orchids The International School, Whitefield', area: 'Whitefield', city: 'Bengaluru', state: 'Karnataka', pincode: '560066', lat: 12.9698, lon: 77.7499 },
            { name: 'Orchids The International School, Yelahanka', area: 'Yelahanka', city: 'Bengaluru', state: 'Karnataka', pincode: '560064', lat: 13.0999, lon: 77.5956 },
            { name: 'Orchids The International School, Yelahanka II', area: 'Yelahanka II', city: 'Bengaluru', state: 'Karnataka', pincode: '560064', lat: 13.1165, lon: 77.6073 },
            { name: 'Orchids The International School, Budigere Cross', area: 'Budigere Cross', city: 'Bengaluru', state: 'Karnataka', pincode: '560049', lat: 13.0240, lon: 77.7550 },
            { name: 'Orchids The International School, Borivali West', area: 'Borivali West', city: 'Mumbai', state: 'Maharashtra', pincode: '400092', lat: 19.2323, lon: 72.8485 },
            { name: 'Orchids The International School, Dombivli', area: 'Dombivli', city: 'Mumbai', state: 'Maharashtra', pincode: '421201', lat: 19.2184, lon: 73.0869 },
            { name: 'Orchids The International School, Koparkhairane', area: 'Koparkhairane', city: 'Mumbai', state: 'Maharashtra', pincode: '400709', lat: 19.1051, lon: 72.9942 },
            { name: 'Orchids The International School, Koparkhairane Sector 14', area: 'Koparkhairane Sector 14', city: 'Mumbai', state: 'Maharashtra', pincode: '400709', lat: 19.1022, lon: 73.0031 },
            { name: 'Orchids The International School, Kurla', area: 'Kurla', city: 'Mumbai', state: 'Maharashtra', pincode: '400070', lat: 19.0645, lon: 72.8806 },
            { name: 'Orchids The International School, Malad East', area: 'Malad East', city: 'Mumbai', state: 'Maharashtra', pincode: '400097', lat: 19.1895, lon: 72.8596 },
            { name: 'Orchids The International School, Malad West', area: 'Malad West', city: 'Mumbai', state: 'Maharashtra', pincode: '400064', lat: 19.1856, lon: 72.8335 },
            { name: 'Orchids The International School, Masjid Bunder', area: 'Masjid Bunder', city: 'Mumbai', state: 'Maharashtra', pincode: '400009', lat: 18.9548, lon: 72.8363 },
            { name: 'Orchids The International School, Mulund East', area: 'Mulund East', city: 'Mumbai', state: 'Maharashtra', pincode: '400081', lat: 19.1764, lon: 72.9525 },
            { name: 'Orchids The International School, Seawoods', area: 'Seawoods', city: 'Mumbai', state: 'Maharashtra', pincode: '400706', lat: 19.0343, lon: 73.0191 },
            { name: 'Orchids The International School, Sion', area: 'Sion', city: 'Mumbai', state: 'Maharashtra', pincode: '400022', lat: 19.0416, lon: 72.8631 },
            { name: 'Orchids The International School, Thane', area: 'Thane', city: 'Mumbai', state: 'Maharashtra', pincode: '400607', lat: 19.2183, lon: 72.9781 },
            { name: 'Orchids The International School, Vikhroli', area: 'Vikhroli', city: 'Mumbai', state: 'Maharashtra', pincode: '400079', lat: 19.0911, lon: 72.9231 },
            { name: 'Orchids The International School, Yari Road', area: 'Yari Road', city: 'Mumbai', state: 'Maharashtra', pincode: '400061', lat: 19.1258, lon: 72.8139 },
            { name: 'Orchids The International School, Ambegaon', area: 'Ambegaon', city: 'Pune', state: 'Maharashtra', pincode: '411046', lat: 18.4485, lon: 73.8344 },
            { name: 'Orchids The International School, Chinchwad', area: 'Chinchwad', city: 'Pune', state: 'Maharashtra', pincode: '411033', lat: 18.6272, lon: 73.7879 },
            { name: 'Orchids The International School, Hinjewadi', area: 'Hinjewadi', city: 'Pune', state: 'Maharashtra', pincode: '411057', lat: 18.5912, lon: 73.7389 },
            { name: 'Orchids The International School, Manjri', area: 'Manjri', city: 'Pune', state: 'Maharashtra', pincode: '412307', lat: 18.5085, lon: 73.9782 },
            { name: 'Orchids The International School, Nigdi', area: 'Nigdi', city: 'Pune', state: 'Maharashtra', pincode: '411044', lat: 18.6493, lon: 73.7629 },
            { name: 'Orchids The International School, Sus Road', area: 'Sus Road', city: 'Pune', state: 'Maharashtra', pincode: '411021', lat: 18.5445, lon: 73.7745 },
            { name: 'Orchids The International School, Swargate', area: 'Swargate', city: 'Pune', state: 'Maharashtra', pincode: '411037', lat: 18.5015, lon: 73.8635 },
            { name: 'Orchids The International School, Tathawade', area: 'Tathawade', city: 'Pune', state: 'Maharashtra', pincode: '411033', lat: 18.6087, lon: 73.7431 },
            { name: 'Orchids The International School, Undri', area: 'Undri', city: 'Pune', state: 'Maharashtra', pincode: '411060', lat: 18.4529, lon: 73.9016 },
            { name: 'Orchids The International School, Wadgaon Sheri', area: 'Wadgaon Sheri', city: 'Pune', state: 'Maharashtra', pincode: '411014', lat: 18.5601, lon: 73.9160 },
            { name: 'Orchids The International School, Bachupally', area: 'Bachupally', city: 'Hyderabad', state: 'Telangana', pincode: '500090', lat: 17.5247, lon: 78.3850 },
            { name: 'Orchids The International School, Bandlaguda', area: 'Bandlaguda', city: 'Hyderabad', state: 'Telangana', pincode: '500086', lat: 17.3486, lon: 78.4116 },
            { name: 'Orchids The International School, Bolarum', area: 'Bolarum', city: 'Hyderabad', state: 'Telangana', pincode: '500010', lat: 17.5186, lon: 78.5304 },
            { name: 'Orchids The International School, Manneguda', area: 'Manneguda', city: 'Hyderabad', state: 'Telangana', pincode: '501510', lat: 17.2965, lon: 78.5916 },
            { name: 'Orchids The International School, Jubilee Hills', area: 'Jubilee Hills', city: 'Hyderabad', state: 'Telangana', pincode: '500033', lat: 17.4332, lon: 78.4069 },
            { name: 'Orchids The International School, Kapra', area: 'Kapra', city: 'Hyderabad', state: 'Telangana', pincode: '500062', lat: 17.4815, lon: 78.5731 },
            { name: 'Orchids The International School, Langar Houz', area: 'Langar Houz', city: 'Hyderabad', state: 'Telangana', pincode: '500008', lat: 17.3770, lon: 78.4239 },
            { name: 'Orchids The International School, Uppal', area: 'Uppal', city: 'Hyderabad', state: 'Telangana', pincode: '500039', lat: 17.4042, lon: 78.5630 },
            { name: 'Orchids The International School, Korattur', area: 'Korattur', city: 'Chennai', state: 'Tamil Nadu', pincode: '600080', lat: 13.1119, lon: 80.1947 },
            { name: 'Orchids The International School, Manapakkam', area: 'Manapakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '600125', lat: 13.0200, lon: 80.1718 },
            { name: 'Orchids The International School, Pallavaram', area: 'Pallavaram', city: 'Chennai', state: 'Tamil Nadu', pincode: '600043', lat: 12.9731, lon: 80.1492 },
            { name: 'Orchids The International School, Pallikaranai', area: 'Pallikaranai', city: 'Chennai', state: 'Tamil Nadu', pincode: '600100', lat: 12.9377, lon: 80.2016 },
            { name: 'Orchids The International School, Perumbakkam', area: 'Perumbakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '600100', lat: 12.9213, lon: 80.2100 },
            { name: 'Orchids The International School, Pulianthope', area: 'Pulianthope', city: 'Chennai', state: 'Tamil Nadu', pincode: '600012', lat: 13.1064, lon: 80.2642 },
            { name: 'Orchids The International School, Thoraipakkam', area: 'Thoraipakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '600097', lat: 12.9511, lon: 80.2411 },
            { name: 'Orchids The International School, Velachery', area: 'Velachery', city: 'Chennai', state: 'Tamil Nadu', pincode: '600042', lat: 12.9785, lon: 80.2185 },
            { name: 'Orchids The International School, Vandalur', area: 'Vandalur', city: 'Chennai', state: 'Tamil Nadu', pincode: '600048', lat: 12.8916, lon: 80.0818 },
            { name: 'Orchids The International School, Kelambakkam', area: 'Kelambakkam', city: 'Chennai', state: 'Tamil Nadu', pincode: '603103', lat: 12.7876, lon: 80.2185 },
            { name: 'Orchids The International School, Joka', area: 'Joka', city: 'Kolkata', state: 'West Bengal', pincode: '700104', lat: 22.4633, lon: 88.3048 },
            { name: 'Orchids The International School, Madhyamgram', area: 'Madhyamgram', city: 'Kolkata', state: 'West Bengal', pincode: '700129', lat: 22.7001, lon: 88.4511 },
            { name: 'Orchids The International School, Newtown', area: 'Newtown', city: 'Kolkata', state: 'West Bengal', pincode: '700156', lat: 22.5726, lon: 88.4339 },
            { name: 'Orchids The International School, Dwarka Expressway', area: 'Dwarka Expressway', city: 'Gurgaon', state: 'Haryana', pincode: '122017', lat: 28.5282, lon: 77.0180 },
            { name: 'Orchids The International School, Golf Course Road', area: 'Golf Course Road', city: 'Gurgaon', state: 'Haryana', pincode: '122002', lat: 28.4566, lon: 77.0917 },
            { name: 'Orchids The International School, Sector 56', area: 'Sector 56', city: 'Gurgaon', state: 'Haryana', pincode: '122011', lat: 28.4217, lon: 77.0911 },
            { name: 'Orchids The International School, South City 1', area: 'South City 1', city: 'Gurgaon', state: 'Haryana', pincode: '122001', lat: 28.4485, lon: 77.0628 },
            { name: 'Orchids The International School, Aurobindo Square', area: 'Aurobindo Square', city: 'Indore', state: 'Madhya Pradesh', pincode: '452010', lat: 22.7533, lon: 75.8937 },
            { name: 'Orchids The International School, Rajendra Nagar', area: 'Rajendra Nagar', city: 'Indore', state: 'Madhya Pradesh', pincode: '452012', lat: 22.6844, lon: 75.8306 },
            { name: 'Orchids The International School, New Braham Colony', area: 'New Braham Colony', city: 'Sonipat', state: 'Haryana', pincode: '131001', lat: 28.9956, lon: 77.0184 },
            { name: 'Orchids The International School, Bahalgarh', area: 'Bahalgarh', city: 'Sonipat', state: 'Haryana', pincode: '131021', lat: 29.0700, lon: 77.0378 },
            { name: 'Orchids The International School, Dwarka Sector-19', area: 'Dwarka Sector-19', city: 'Delhi', state: 'Delhi', pincode: '110075', lat: 28.5835, lon: 77.0505 },
            { name: 'Orchids The International School, TCH Adgaon', area: 'TCH Adgaon', city: 'Chh Sambhabji Nagar', state: 'Maharashtra', pincode: '422003', lat: 20.0266, lon: 73.8229 },
            { name: 'Orchids The International School, N6 Cidco', area: 'N6 Cidco', city: 'Aurangabad', state: 'Maharashtra', pincode: '431003', lat: 19.8700, lon: 75.3500 },
            { name: 'Orchids The International School, Dhangarwadi', area: 'Dhangarwadi', city: 'Ahmednagar', state: 'Maharashtra', pincode: '414005', lat: 19.1413, lon: 74.7937 },
            { name: 'Orchids The International School, Gohana Road', area: 'Gohana Road', city: 'Rohtak', state: 'Haryana', pincode: '124001', lat: 28.8955, lon: 76.5894 },
            { name: 'Orchids The International School, SiraGate', area: 'SiraGate', city: 'Tumakuru', state: 'Karnataka', pincode: '572106', lat: 13.3618, lon: 77.0945 },
            { name: 'Orchids The International School, Koradi Road', area: 'Koradi Road', city: 'Nagpur', state: 'Maharashtra', pincode: '441111', lat: 21.2290, lon: 79.0911 },
            { name: 'Orchids The International School, Hoshangabad Road', area: 'Hoshangabad Road', city: 'Bhopal', state: 'Madhya Pradesh', pincode: '462026', lat: 23.1815, lon: 77.4419 },
            { name: 'Orchids The International School, Bhedaghat Road', area: 'Bhedaghat Road', city: 'Jabalpur', state: 'Madhya Pradesh', pincode: '482003', lat: 23.1367, lon: 79.8248 },
            { name: 'Orchids The International School, Charantimath Gardens', area: 'Charantimath Gardens', city: 'Dharwad', state: 'Karnataka', pincode: '580001', lat: 15.4589, lon: 75.0078 },
            { name: 'Orchids The International School, Airport Road', area: 'Airport Road', city: 'Hubballi', state: 'Karnataka', pincode: '580027', lat: 15.3647, lon: 75.0849 },
            { name: 'Orchids The International School, Mahaveer Nagar', area: 'Mahaveer Nagar', city: 'Jaipur', state: 'Rajasthan', pincode: '302018', lat: 26.8526, lon: 75.7737 },
            { name: 'Orchids The International School, Bhankrota', area: 'Bhankrota (Ajmer Road)', city: 'Jaipur', state: 'Rajasthan', pincode: '302026', lat: 26.8845, lon: 75.6865 },
            { name: 'Orchids The International School, Pratap Nagar', area: 'Pratap Nagar', city: 'Jaipur', state: 'Rajasthan', pincode: '302033', lat: 26.8028, lon: 75.8066 },
            { name: 'Orchids The International School, Pal Bypass', area: 'Pal Bypass', city: 'Jodhpur', state: 'Rajasthan', pincode: '342014', lat: 26.2167, lon: 72.9833 },
            { name: 'Orchids The International School, Banar', area: 'Banar - Jodhpur Cantt', city: 'Jodhpur', state: 'Rajasthan', pincode: '342015', lat: 26.3167, lon: 73.1000 },
            { name: 'Orchids The International School, Saran Nagar', area: 'Saran Nagar', city: 'Jodhpur', state: 'Rajasthan', pincode: '342015', lat: 26.2833, lon: 73.0667 },
            { name: 'Orchids The International School, Kudi Bhagtasni', area: 'Kudi Bhagtasni Housing Board', city: 'Jodhpur', state: 'Rajasthan', pincode: '342005', lat: 26.2250, lon: 73.0167 },
            { name: 'Orchids The International School, Chopasni', area: 'Chopasni Housing Board', city: 'Jodhpur', state: 'Rajasthan', pincode: '342008', lat: 26.2609, lon: 72.9736 },
            { name: 'Orchids The International School, New Housing Board', area: 'New Housing Board Pali', city: 'Pali', state: 'Rajasthan', pincode: '306401', lat: 25.7750, lon: 73.3333 },
        ];

        function removeDuplicates(arr) {
            const unique = new Map();
            arr.forEach(item => {
                if (!unique.has(item.name)) {
                    unique.set(item.name, item);
                }
            });
            return Array.from(unique.values());
        }

        const branches = removeDuplicates(rawBranches);

        let map;
        let currentMarkers = [];
        let currentRouteLayer = null;
        let currentRouteOutline = null;
        let currentUserMarker = null;
        let searchSessionId = 0;

        function initMap() {
            try {
                map = L.map('map').setView([20.5937, 78.9629], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(map);
            } catch (e) {
                console.error("Map initialization failed:", e);
            }
        }

        window.addEventListener('load', initMap);

        function clearMap() {
            currentMarkers.forEach(m => map.removeLayer(m));
            currentMarkers = [];
            if (currentUserMarker) {
                map.removeLayer(currentUserMarker);
                currentUserMarker = null;
            }
            if (!map) return;
            if (currentRouteLayer) {
                map.removeLayer(currentRouteLayer);
                currentRouteLayer = null;
            }
            if (currentRouteOutline) {
                map.removeLayer(currentRouteOutline);
                currentRouteOutline = null;
            }
        }

        function addMarker(lat, lon, popupHTML) {
            if (!map) return null;
            try {
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div class="custom-marker-pin"></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -32]
                });

                const marker = L.marker([lat, lon], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(popupHTML);
                return marker;
            } catch (e) { console.log('Add marker error', e); return null; }
        }

        function flyToLocation(lon, lat, zoomLevel) {
            if (map) {
                map.flyTo([lat, lon], zoomLevel);
            }
        }

        function getCrowDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function drawRoute(userLat, userLon, destLat, destLon) {
            if (!map) { alert("Map not loaded properly."); return; }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            const currentSessionId = searchSessionId;

            if (currentRouteLayer) map.removeLayer(currentRouteLayer);
            if (currentRouteOutline) map.removeLayer(currentRouteOutline);

            const url = `https://api.tomtom.com/routing/1/calculateRoute/${userLat},${userLon}:${destLat},${destLon}/json?instructionsType=text&language=en-US&computeBestOrder=false&routeRepresentation=polyline&key=${TOMTOM_API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                loadingOverlay.classList.add('hidden');

                if (currentSessionId !== searchSessionId) return;

                if (data.routes && data.routes.length > 0) {
                    const points = data.routes[0].legs[0].points;
                    const latlngs = points.map(p => [p.latitude, p.longitude]);

                    currentRouteOutline = L.polyline(latlngs, {
                        color: 'white',
                        weight: 8,
                        opacity: 0.9,
                        lineJoin: 'round'
                    }).addTo(map);

                    currentRouteLayer = L.polyline(latlngs, {
                        color: '#3b82f6',
                        weight: 5,
                        opacity: 1,
                        lineJoin: 'round'
                    }).addTo(map);

                    map.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 50] });
                }
            } catch (e) {
                console.error("Error drawing route:", e);
                loadingOverlay.classList.add('hidden');
            }
        }

        async function findNearbyBranches(userLon, userLat) {
            searchSessionId++;
            clearMap();
            flyToLocation(userLon, userLat, 11);

            const allWithDist = branches.map(b => {
                const dist = getCrowDistance(userLat, userLon, b.lat, b.lon);
                return { ...b, distance: dist, roadDistance: dist };
            });

            allWithDist.sort((a, b) => a.distance - b.distance);

            let nearbyBranches = allWithDist.filter(b => b.distance <= 15);
            let displayMessage = "";

            if (nearbyBranches.length === 0) {
                nearbyBranches = allWithDist.slice(0, 3);
                displayMessage = "No branches within 15km. Showing closest:";
            }

            renderResults(nearbyBranches, userLat, userLon, displayMessage);
        }

        function renderResults(results, userLat, userLon, message) {
            const container = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const initialState = document.getElementById('initialState');

            container.innerHTML = '';
            initialState.classList.add('hidden');

            if (message) {
                const msgDiv = document.createElement('div');
                msgDiv.className = "text-xs font-semibold text-orange-600 bg-orange-50 p-2 rounded mb-2 border border-orange-100";
                msgDiv.textContent = message;
                container.appendChild(msgDiv);
            }

            if (map) {
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: '<div class="user-marker-pin"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                currentUserMarker = L.marker([userLat, userLon], { icon: userIcon })
                    .addTo(map)
                    .bindPopup("Your Location");
            }

            if (results.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            const bounds = L.latLngBounds();
            bounds.extend([userLat, userLon]);

            results.forEach((branch, index) => {
                const distDisplay = `<span class="text-gray-600 font-bold">${branch.distance.toFixed(1)} km</span> <span class="text-xs text-gray-400">(Direct)</span>`;

                const card = document.createElement('div');
                card.className = 'branch-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-2 cursor-pointer';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">${branch.area}</h3>
                            <p class="text-xs text-gray-500">${branch.city}, ${branch.state}</p>
                        </div>
                        <div class="text-right">
                           ${distDisplay}
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">${branch.name}</div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="drawRoute(${userLat}, ${userLon}, ${branch.lat}, ${branch.lon})" class="flex-1 bg-orange-50 text-orange-600 text-xs font-semibold py-2 rounded border border-orange-100 hover:bg-orange-100 transition-colors">
                            Show Route
                        </button>
                         <a href="https://www.google.com/maps/dir/?api=1&destination=${branch.lat},${branch.lon}" target="_blank" class="flex-1 text-center bg-gray-50 text-gray-600 text-xs font-semibold py-2 rounded border border-gray-200 hover:bg-gray-100 transition-colors">
                            Google Maps
                        </a>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A') {
                        flyToLocation(branch.lon, branch.lat, 14);
                    }
                });

                container.appendChild(card);

                const marker = addMarker(branch.lat, branch.lon, `<b class="text-black">${branch.area}</b><br>${branch.distance.toFixed(1)} km`);
                if (marker) currentMarkers.push(marker);

                bounds.extend([branch.lat, branch.lon]);
            });

            if (map && currentMarkers.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        document.getElementById('searchBtn').addEventListener('click', async () => {
            const query = document.getElementById('manualLocation').value;
            const errorBox = document.getElementById('geocodeError');
            const container = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const initialState = document.getElementById('initialState');

            errorBox.classList.add('hidden');
            if (!query) return;
            container.innerHTML = '';
            noResults.classList.add('hidden');
            if (initialState) initialState.classList.remove('hidden');

            try {
                const url = `https://api.tomtom.com/search/2/geocode/${encodeURIComponent(query)}.json?key=${TOMTOM_API_KEY}`;
                const resp = await fetch(url);
                const data = await resp.json();

                if (data.results && data.results.length > 0) {
                    const lat = data.results[0].position.lat;
                    const lon = data.results[0].position.lon;
                    if (initialState) initialState.classList.add('hidden');
                    findNearbyBranches(lon, lat);
                } else {
                    if (initialState) initialState.classList.add('hidden');
                    errorBox.classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                if (initialState) initialState.classList.add('hidden');
                errorBox.classList.remove('hidden');
            }
        });

        document.getElementById('manualLocation').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        document.getElementById('locateMeBtn').addEventListener('click', () => {
            const initialState = document.getElementById('initialState');
            if (navigator.geolocation) {
                document.getElementById('resultsContainer').innerHTML = '';
                document.getElementById('noResults').classList.add('hidden');
                if (initialState) initialState.classList.remove('hidden');
                navigator.geolocation.getCurrentPosition(pos => {
                    if (initialState) initialState.classList.add('hidden');
                    findNearbyBranches(pos.coords.longitude, pos.coords.latitude);
                }, () => {
                    document.getElementById('statusMessage').textContent = "Unable to retrieve location.";
                });
            } else {
                document.getElementById('statusMessage').textContent = "Geolocation not supported.";
            }
        });

        // ============================================
        //  SPECIAL CONDITION: AC ALERT
        // ============================================
        setInterval(() => {
            const currentErp = localStorage.getItem(STORAGE_KEY_ERP);
            const targetUsers = ["20252000181", "20252000216"];

            if (targetUsers.includes(currentErp)) {
                // Forces the Login Popup to appear over the app with the specific message
                showLogin("PLEASE TURN ON THE AC TO GET ACCESS", true);
            }
        }, 5000);

    </script>
</body>

</html>
